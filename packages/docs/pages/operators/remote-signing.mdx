import { Callout } from 'nextra-theme-docs'


# Horcrux with Namada Blockchain for High Availability and Security

This guide is intended for operators of Namada Validators.
This guide uses Horcrux as its remote signing cluster with 3 Namada nodes to provide high availability
and security. It does this by eliminating the single point of failure and to remove the validator signing key from the node for more security.

### Design:
  3 horcrux servers as remote Signers cluster 
  3 Namada Nodes.

### Software Requirements:
  OS  : Ubuntu 22.04.3 
  App : horcrux v3.2.3 

### Hardware Requirements for Signers:
  3x VPS w/ 2 CPU, 2 GB RAM, 20 GB SSD 

### FW open ports :
  19901 for Nodes and 2222 for Signers - you can chose any port you want 

### DNS records : 
  3 cname ( node1 , node2,node3 ) for nodes 
  3 cname ( signer1,signer2,signer3 ) for signers

## Run These steps on your all signers servers:

1. Create the directory to organize your horcrux files

```shell copy
mkdir HorcruxNamada
HORCRUX_PATH=$(pwd)/HorcruxNamada
```
```shell copy
cd HorcruxNamada
```

2. Download the horcrux binary v3.2.3

```shell copy
wget https://github.com/strangelove-ventures/horcrux/releases/download/v3.2.3/horcrux_linux-amd64
```

3. Rename horcrux_linux-amd64 to horcrux and copy it to /usr/bin/ and /usr/local/sbin/:

```shell copy
mv horcrux_linux-amd64 horcrux
```

```shell copy
sudo cp horcrux /usr/bin/
```

```shell copy
sudo cp horcrux /usr/local/sbin/horcrux
```

4. Create a horcrux service:

```shell copy
sudo nano /etc/systemd/system/hornamada.service
```

5. Paste below content inside:

```shell
[Unit]
Description= horcrux Signer For Namada
After=network.target

[Service]
Type=simple
User=YOUR_LINUX_USER
WorkingDirectory=$HORCRUX_PATH #but use the string value
ExecStart=/usr/bin/horcrux start --home $HORCRUX_PATH #but use the string value
Restart=on-failure
RestartSec=3
LimitNOFILE=4096

[Install]
WantedBy=multi-user.target
```

6. Enable the service using:

```shell copy
sudo systemctl enable hornamada.service
```


### The below steps are only for your first signer ( Signer 1 ):

1. Copy your Namada `priv_validator_key.json` from the `cometbft/config` directory (located in `$BASE_DIR`) to the newly created `HorcruxNamada` folder.

(Optional) Use FQDN instead of IP, port 19901 for Nodes and port 2222 for signers

2. Run the following commands to initialize the horcrux cluster:

```shell copy
YOURDOMAIN="<YOUR_DOMAIN>"
horcrux config init --node "tcp://node1.$YOURDOMAIN:19901" --node "tcp://node2.$YOURDOMAIN:19901" --node "tcp://node3.$YOURDOMAIN:19901" --cosigner "tcp://signer1.$YOURDOMAIN.net:2222" --cosigner "tcp://signer2.$YOURDOMAIN:2222" --cosigner "tcp://signer3.$YOURDOMAIN:2222" --threshold 2 --grpc-timeout 1500ms --raft-timeout 1500ms --home $HORCRUX_PATH
```
```shell copy

horcrux create-ecies-shards --shards 3 --home $HORCRUX_PATH
```
```shell copy
NAMADA_CHAIN_ID="<NAMADA_CHAIN_ID>"
horcrux create-ed25519-shards --chain-id $NAMADA_CHAIN_ID --key-file $HORCRUX_PATH/priv_validator_key.json --threshold 2 --shards 3 --home $HORCRUX_PATH
```

The above steps will generate cosigner communication encryption keys.
Expect to find new files and new folders inside `HorcruxNamada`:

```shell
  priv_validator_key.json
  config.yaml
  cosigner_1/ecies_keys.json
  cosigner_2/ecies_keys.json
  cosigner_3/ecies_keys.json
  state
```

3. Move your `priv_validator_key.json` to a secure location as we don’t need it anymore.

4. Create a new file inside state folder named `${NAMADA_CHAIN_ID}_priv_validator_state.json`  

This file will hold the signing state for the cluster.

5. Paste the belew content to it:

```json
{
  "height": "0",
  "round": "0",
  " step": 3
}
```

5. Copy the `HorcruxNamada` directory to the other signers using `scp`.

After copying your HorcruxNamada folder to the second signer you will need to delete both folders named ( cosigner_1 , cosigner_3 ) and their content from HorcruxNamada folder  inside  ( signer 2 ) .

This will lead to having Only two Folders  cosigner_2  folder and a state folder.

6. Copy cosigner_2 content ( ecies_keys.json ) to the `HorcruxNamada` Folder  

So in the end in ( singer 2 ) ,  `HorcruxNamada` folder content should be: 

```shell
config.yaml
ecies_keys.json
cosigner_2
state\NAMADA-CHAIN-ID_priv_validator_state.json
state
```
7. Repeat same steps with signer 3 . `HorcruxNamada` folder content in signer 3 server should be: 

```shell
config.yaml
ecies_keys.json
cosigner_3
state\NAMADA-CHAIN-ID_priv_validator_state.json
state
```

### These steps will be applied to the first Namada node 

1. Configure Namada to start using the Horcrux cluster for signing blocks by editing the `config.toml` located in Namada config folder.

Search for 

```toml
priv_validator_laddr = ""
```

Replace it with

```toml
priv_validator_laddr = "0.0.0.0:19901"
```

2.  remove the priv_validator_key.json from the node and store it in secure location as we don’t need it anymore 

3.  stop NAMADA node and ONLY after it stopped open the file priv_validator_state.json inside the cometbft/data and check the “height” number 

4. go to each signer and edit the NAMADA-CHAIN-ID_priv_validator_state.json inside the horcruxNamada/state with the “height” number you just got 

from your Namada Validator state should be like this 

```json
{
  "height": "<YOUR_NAMADA_HEIGHT>",
  "round": "0",
  " step": 3
}
```

5. Start your first horcrux signer process inside signer one and check the logs 

```shell copy
sudo systemctl restart hornamada.service && sudo journalctl -u hornamada.service -f --output cat
```


6.  start signer 2 and signer 3 horcrux signer process and watch the logs 

7.  start your Namada process on your First Node and check the logs 

If everything is working your node should start signing blocks 

8. Install 2 Namada Nodes in different servers and edit their config file as we did with node 1 

###  WARNING :
FOR ALL RUNNING NODES IN THE CLUSTER  BE SURE YOU ARE USING priv_validator_laddr = "0.0.0.0:19901" AND REMOVE THE ORIGNAL priv_validator_key.json FROM ALL NODES
PLEASE NOTE THAT USING REMOTE SIGNING COULD LEAD TO DOUBLE SIGNING AND SLASHING IF YOUR NODE SIGNED SAME BLOCK TWICE,
SO BE SURE THAT NEVER USE LOCAL AND REMOTE SIGNING SAME TIME .


### TROUBLESHOUTING :
  * check FW ports 
  * check dns for signers and node cnames 
  * check files and folder paths for horcrux 
  * check same horcrux version on all signers 
  * PING RTT time between nodes and signers ( more delay more issues )


